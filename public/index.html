<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Resume - Custom Workforce Solutions</title>
  <meta name="description" content="Submit your resume to Custom Workforce Solutions for light industrial staffing opportunities.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <!-- Top Row: Brand + User Info -->
      <div>
        <div class="nav-brand">
          <h1>Custom Workforce Solutions</h1>
          <p class="tagline">Find Your Job Match</p>
        </div>
        <div class="user-info-section">
          <span id="userName" class="user-name-display"></span>
          <button onclick="logout()" class="logout-button">Logout</button>
        </div>
      </div>

      <!-- Bottom Row: Navigation Links -->
      <div class="nav-links">
        <a href="/" class="active">Upload</a>
        <a href="/dashboard.html">Dashboard</a>
        <a href="/manage-jobs.html" id="jobsLink" style="display: none;">Jobs</a>
        <a href="/audit.html" id="auditLink" style="display: none;">üîç Audit Trail</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <!-- Hero Section with Images -->
    <div class="hero-section">
      <div class="hero-content">
        <h1 class="hero-title">Find Your Job Match</h1>
        <p class="hero-subtitle">Upload your resume and let our AI-powered system match you with the best manufacturing and warehouse opportunities in the DFW area.</p>
        <div class="hero-features">
          <div class="feature-item">
            <span class="feature-icon">‚ö°</span>
            <span>Instant AI Analysis</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">üéØ</span>
            <span>Smart Job Matching</span>
          </div>
          <div class="feature-item">
            <span class="feature-icon">üìç</span>
            <span>Local DFW Positions</span>
          </div>
        </div>
      </div>
      <div class="hero-image">
        <img src="https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=800&h=600&fit=crop&q=80"
             alt="Industrial workers in modern warehouse"
             loading="eager"
             style="border-radius: 15px; box-shadow: 0 20px 60px rgba(164, 196, 222, 0.3);">
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-number">500+</div>
        <div class="stat-label">Placements</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">98%</div>
        <div class="stat-label">Match Rate</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">24hrs</div>
        <div class="stat-label">Avg Response</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">50+</div>
        <div class="stat-label">Partner Companies</div>
      </div>
    </div>

    <div class="upload-section">
      <div class="upload-header">
        <h2>Upload Your Resume</h2>
        <p>Drag and drop your resume or click to browse</p>
        <p class="subtitle">We accept PDF, DOCX, DOC, and TXT files</p>
        <p class="subtitle" style="color: #f59e0b; font-size: 13px; margin-top: 5px;">‚ö†Ô∏è Note: Image formats (JPG, PNG) are not compatible with this system</p>
      </div>

      <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()" style="cursor: pointer;">
        <div class="drop-zone-icon">üìÑ</div>
        <div class="drop-zone-text">
          <p><strong>Drop your resume here</strong></p>
          <p>or</p>
          <button type="button" class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">
            Browse Files
          </button>
        </div>
        <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.txt,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain" style="display: none;">
      </div>

      <div id="uploadStatus" class="upload-status" style="display: none;"></div>

      <!-- AI Recruiter Processing Interface -->
      <div id="loadingBar" class="ai-processing-container" style="display: none;">
        <div class="ai-processing-content">
          <!-- AI Avatar -->
          <div class="ai-avatar">
            <div class="ai-avatar-circle">
              <span class="ai-icon">ü§ñ</span>
            </div>
            <div class="ai-status-pulse"></div>
          </div>

          <!-- Processing Header -->
          <div class="ai-header">
            <h3 id="aiProcessingHeader">AI Recruiter</h3>
            <span class="ai-status-badge" id="aiStatusBadge">Processing</span>
          </div>

          <!-- AI Thinking Messages -->
          <div class="ai-thinking-box">
            <div class="thinking-indicator">
              <span class="thinking-dot"></span>
              <span class="thinking-dot"></span>
              <span class="thinking-dot"></span>
            </div>
            <p id="aiThinkingMessage" class="ai-message">I'm processing your resume...</p>
          </div>

          <!-- Processing Steps -->
          <div class="ai-steps-container">
            <div class="ai-step" id="step1">
              <div class="step-icon">üìÑ</div>
              <span class="step-text">Reading resume</span>
              <div class="step-status">‚è≥</div>
            </div>
            <div class="ai-step" id="step2">
              <div class="step-icon">üîç</div>
              <span class="step-text">Extracting information</span>
              <div class="step-status">‚è≥</div>
            </div>
            <div class="ai-step" id="step3">
              <div class="step-icon">üß†</div>
              <span class="step-text">Analyzing experience</span>
              <div class="step-status">‚è≥</div>
            </div>
            <div class="ai-step" id="step4">
              <div class="step-icon">üéØ</div>
              <span class="step-text">Matching jobs</span>
              <div class="step-status">‚è≥</div>
            </div>
            <div class="ai-step" id="step5">
              <div class="step-icon">üìä</div>
              <span class="step-text">Calculating scores</span>
              <div class="step-status">‚è≥</div>
            </div>
            <div class="ai-step" id="step6">
              <div class="step-icon">üí°</div>
              <span class="step-text">Generating recommendations</span>
              <div class="step-status">‚è≥</div>
            </div>
          </div>

          <!-- Progress Bar (subtle) -->
          <div class="progress-bar-subtle">
            <div class="progress-fill-subtle" id="progressFill"></div>
          </div>
        </div>
      </div>

      <div id="resultsSection" class="results-section" style="display: none;">
        <h3>‚úÖ Resume Processed Successfully!</h3>
        <div id="candidateInfo" class="info-card"></div>
        <div id="matchResults" class="match-results"></div>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="location.reload()">Upload Another Resume</button>
          <a href="/dashboard.html" class="btn btn-secondary">View Dashboard</a>
        </div>
      </div>
    </div>

    <div class="info-section">
      <div class="info-card">
        <h3>How It Works</h3>
        <ol>
          <li><strong>Upload Resume:</strong> Drag and drop or select a resume file</li>
          <li><strong>AI Analysis:</strong> Our AI compares the resume against active job openings</li>
          <li><strong>Get Results:</strong> View match scores and detailed comparisons instantly to your email.</li>
        </ol>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-branding">
        <h3>Custom Workforce Solutions</h3>
        <p>Find Your Job Match</p>
      </div>
      <a href="mailto:AiRecruiter@customworkforcesolutionsllc.com" class="footer-email">
        AiRecruiter@customworkforcesolutionsllc.com
      </a>
      <p class="footer-powered">
        Powered by Fabien P / AI Resume Screening Technology
      </p>
    </div>
  </footer>

  <script>
    // Check authentication on page load
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();

        if (data.authenticated) {
          document.getElementById('userName').textContent = data.user.name;

          // Show jobs and audit trail links only for admin users
          if (data.user.role === 'admin') {
            document.getElementById('jobsLink').style.display = 'inline-block';
            document.getElementById('auditLink').style.display = 'inline-block';
          }
        } else {
          window.location.href = '/login.html';
        }
      } catch (error) {
        console.error('Auth check error:', error);
        window.location.href = '/login.html';
      }
    }

    // Logout function
    async function logout() {
      try {
        await fetch('/api/logout', { method: 'POST' });
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/login.html';
      }
    }

    // Check auth on page load
    checkAuth();

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadStatus = document.getElementById('uploadStatus');
    const resultsSection = document.getElementById('resultsSection');

    // Drag and drop handlers
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });

    async function handleFile(file) {
      // Validate file
      const allowedTypes = [
        'application/pdf',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/msword',
        'text/plain',
        'image/jpeg',
        'image/jpg',
        'image/png'
      ];
      if (!allowedTypes.includes(file.type)) {
        showError('Please upload a PDF, DOCX, DOC, TXT, JPG, or PNG file');
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        showError('File size must be less than 10MB');
        return;
      }

      // Hide previous results and status
      uploadStatus.style.display = 'none';
      resultsSection.style.display = 'none';

      // Show loading bar - Step 1
      showLoadingBar();

      // Upload file
      const formData = new FormData();
      formData.append('resume', file);

      try {
        // Stage 1: Initial processing message
        await new Promise(resolve => setTimeout(resolve, 600));
        updateLoadingProgress(15);

        // Stage 2: Reading resume
        await new Promise(resolve => setTimeout(resolve, 700));
        updateLoadingProgress(25);

        // Start the actual upload
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });

        // Stage 3: Extracting information
        await new Promise(resolve => setTimeout(resolve, 800));
        updateLoadingProgress(40);

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Upload failed');
        }

        // Stage 4: Analyzing experience (AI thinking time)
        await new Promise(resolve => setTimeout(resolve, 1200));
        updateLoadingProgress(60);

        // Stage 5: Comparing against jobs (main AI work)
        await new Promise(resolve => setTimeout(resolve, 1000));
        updateLoadingProgress(75);

        // Stage 6: Calculating scores
        await new Promise(resolve => setTimeout(resolve, 800));
        updateLoadingProgress(90);

        // Final stage: Generating recommendations
        await new Promise(resolve => setTimeout(resolve, 700));
        updateLoadingProgress(100);

        await new Promise(resolve => setTimeout(resolve, 500));

        hideLoadingBar();
        showResults(data);
      } catch (error) {
        hideLoadingBar();
        showError('Error: ' + error.message);
      }
    }

    // AI Processing stages
    const aiStages = [
      { step: 1, percent: 0, message: "AI Recruiter is processing your resume...", icon: "üìÑ" },
      { step: 1, percent: 15, message: "I'm reading the resume content...", icon: "üìÑ" },
      { step: 2, percent: 25, message: "I'm extracting candidate information...", icon: "üîç" },
      { step: 3, percent: 40, message: "I'm analyzing work experience and skills...", icon: "üß†" },
      { step: 4, percent: 60, message: "I'm comparing against active job requirements...", icon: "üéØ" },
      { step: 5, percent: 75, message: "I'm calculating match scores and compatibility...", icon: "üìä" },
      { step: 6, percent: 90, message: "I'm generating personalized recommendations...", icon: "üí°" },
      { step: 6, percent: 100, message: "Analysis complete! Preparing your results...", icon: "‚úÖ" }
    ];

    let currentStageIndex = 0;

    function showLoadingBar() {
      const loadingBar = document.getElementById('loadingBar');
      loadingBar.style.display = 'flex';
      currentStageIndex = 0;
      updateAIStage(0);
    }

    function hideLoadingBar() {
      const loadingBar = document.getElementById('loadingBar');
      loadingBar.style.display = 'none';
      // Reset all steps
      for (let i = 1; i <= 6; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (stepEl) {
          stepEl.classList.remove('active', 'completed');
          const statusEl = stepEl.querySelector('.step-status');
          if (statusEl) statusEl.textContent = '‚è≥';
        }
      }
    }

    function updateAIStage(stageIndex) {
      if (stageIndex >= aiStages.length) return;

      const stage = aiStages[stageIndex];
      currentStageIndex = stageIndex;

      // Update progress bar
      const progressFill = document.getElementById('progressFill');
      progressFill.style.width = stage.percent + '%';

      // Update thinking message with animation
      const messageEl = document.getElementById('aiThinkingMessage');
      messageEl.style.animation = 'none';
      setTimeout(() => {
        messageEl.textContent = stage.message;
        messageEl.style.animation = 'fadeInMessage 0.5s ease-out';
      }, 50);

      // Update step status
      updateStepStatus(stage.step);
    }

    function updateStepStatus(activeStep) {
      for (let i = 1; i <= 6; i++) {
        const stepEl = document.getElementById(`step${i}`);
        const statusEl = stepEl?.querySelector('.step-status');

        if (!stepEl || !statusEl) continue;

        if (i < activeStep) {
          // Completed step
          stepEl.classList.remove('active');
          stepEl.classList.add('completed');
          statusEl.textContent = '‚úÖ';
        } else if (i === activeStep) {
          // Active step
          stepEl.classList.remove('completed');
          stepEl.classList.add('active');
          statusEl.textContent = '‚è≥';
        } else {
          // Pending step
          stepEl.classList.remove('active', 'completed');
          statusEl.textContent = '‚è≥';
        }
      }
    }

    function advanceAIStage() {
      currentStageIndex++;
      if (currentStageIndex < aiStages.length) {
        updateAIStage(currentStageIndex);
      }
    }

    function updateLoadingProgress(percent, stepMessage) {
      // Find the closest stage to the percent
      for (let i = 0; i < aiStages.length; i++) {
        if (aiStages[i].percent >= percent) {
          updateAIStage(i);
          break;
        }
      }
    }

    function showStatus(message, type = 'info') {
      uploadStatus.style.display = 'block';
      uploadStatus.className = `upload-status ${type}`;
      uploadStatus.innerHTML = message;
    }

    function showError(message) {
      showStatus(`‚ùå ${message}`, 'error');
    }

    function showResults(data) {
      uploadStatus.style.display = 'none';
      resultsSection.style.display = 'block';

      // Show candidate info
      const candidateInfo = document.getElementById('candidateInfo');
      candidateInfo.innerHTML = `
        <h4>Candidate Information</h4>
        <p><strong>Name:</strong> ${data.candidate.name || 'Not detected'}</p>
        <p><strong>Email:</strong> ${data.candidate.email || 'Not detected'}</p>
        <p><strong>Phone:</strong> ${data.candidate.phone || 'Not detected'}</p>
      `;

      // Show match results
      const matchResults = document.getElementById('matchResults');
      if (data.comparisons && data.comparisons.length > 0) {
        matchResults.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="margin: 0;">Match Results</h4>
            <span style="color: #6b7280; font-size: 13px;">üìä Sorted by Match % (Highest First)</span>
          </div>
          ${data.comparisons.map(comp => `
            <div class="match-card">
              ${comp.employment_gap_detected ? `
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin-bottom: 12px; border-radius: 4px;">
                  <strong style="color: #92400e;">‚ö†Ô∏è EMPLOYMENT GAP DETECTED</strong>
                  <p style="margin: 5px 0 0 0; color: #78350f; font-size: 13px;">${comp.employment_gap_details}</p>
                </div>
              ` : ''}
              ${comp.distance_info && comp.distance_info.success ? `
                <div style="background: ${comp.distance_info.commute_reasonable === true ? '#d1fae5' : comp.distance_info.commute_reasonable === false ? '#fee2e2' : '#f3f4f6'}; border-left: 4px solid ${comp.distance_info.commute_reasonable === true ? '#10b981' : comp.distance_info.commute_reasonable === false ? '#ef4444' : '#9ca3af'}; padding: 12px; margin-bottom: 12px; border-radius: 4px;">
                  <strong style="color: ${comp.distance_info.commute_reasonable === true ? '#065f46' : comp.distance_info.commute_reasonable === false ? '#991b1b' : '#374151'};">üöó Distance: ${comp.distance_info.distance_miles} miles (${comp.distance_info.distance_km} km)</strong>
                  <p style="margin: 5px 0 0 0; color: ${comp.distance_info.commute_reasonable === true ? '#065f46' : comp.distance_info.commute_reasonable === false ? '#991b1b' : '#374151'}; font-size: 13px;">
                    ${comp.distance_info.commute_description || (comp.distance_info.commute_reasonable === true ? '‚úì Reasonable commute distance' : comp.distance_info.commute_reasonable === false ? '‚ö†Ô∏è Long commute - verify candidate is willing to travel' : 'Commute assessment unavailable')}
                  </p>
                </div>
              ` : ''}
              <div class="match-header">
                <h5>${comp.job_title}</h5>
                <div class="score-badge score-${getScoreLevel(comp.match_score)}">
                  ${comp.match_score}% Match
                </div>
              </div>
              <div class="match-details">
                <div class="detail-section">
                  <strong class="text-success">‚úÖ Strengths:</strong>
                  <div>${formatText(comp.strengths)}</div>
                </div>
                <div class="detail-section">
                  <strong class="text-warning">‚ö†Ô∏è Gaps:</strong>
                  <div>${formatText(comp.gaps)}</div>
                </div>
                <div class="detail-section">
                  <strong>üí° Recommendations:</strong>
                  <div>${formatText(comp.recommendations)}</div>
                </div>
              </div>
            </div>
          `).join('')}
        `;
      } else {
        matchResults.innerHTML = '<p>No active job positions to compare against.</p>';
      }
    }

    function getScoreLevel(score) {
      if (score >= 90) return 'excellent';
      if (score >= 75) return 'strong';
      if (score >= 60) return 'good';
      if (score >= 40) return 'moderate';
      return 'poor';
    }

    function formatText(text) {
      if (!text) return '<p>No information</p>';
      return text.split('\n')
        .filter(line => line.trim())
        .map(line => {
          line = line.trim().replace(/^[-‚Ä¢*]\s*/, '');
          return `<p>‚Ä¢ ${line}</p>`;
        })
        .join('');
    }
  </script>
</body>
</html>
