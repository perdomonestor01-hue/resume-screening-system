<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Jobs - Custom Workforce Solutions</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <h1>Custom Workforce Solutions</h1>
        <p class="tagline">Your Trusted Partner for Light Industrial Staffing Solutions!</p>
      </div>
      <div class="nav-links">
        <a href="/">Upload</a>
        <a href="/dashboard.html">Dashboard</a>
        <a href="/manage-jobs.html" class="active">Jobs</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="jobs-header">
      <h2>Job Descriptions</h2>
      <button class="btn btn-primary" onclick="window.location.href='/jobs.html'">+ Add New Job</button>
    </div>

    <div id="jobsLoading" class="loading">Loading jobs...</div>
    <div id="jobsContainer"></div>
  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-branding">
        <h3>Custom Workforce Solutions</h3>
        <p>Your Trusted Partner for Light Industrial Staffing Solutions</p>
      </div>
      <a href="mailto:recruiting@customworkforcesolutions.com" class="footer-email">
        recruiting@customworkforcesolutions.com
      </a>
      <p class="footer-powered">
        Powered by Fabien P / AI Resume Screening Technology
      </p>
    </div>
  </footer>

  <script>
    let allJobs = [];

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      const options = {
        timeZone: 'America/Chicago',
        month: '2-digit',
        day: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      };
      const parts = new Intl.DateTimeFormat('en-US', options).formatToParts(date);

      const month = parts.find(p => p.type === 'month').value;
      const day = parts.find(p => p.type === 'day').value;
      const year = parts.find(p => p.type === 'year').value;
      const hour = parts.find(p => p.type === 'hour').value;
      const minute = parts.find(p => p.type === 'minute').value;

      return `${month}/${day}/${year} at ${hour}:${minute}`;
    }

    async function loadJobs() {
      try {
        const response = await fetch('/api/jobs');
        allJobs = await response.json();
        displayJobs(allJobs);
        document.getElementById('jobsLoading').style.display = 'none';
      } catch (error) {
        console.error('Error loading jobs:', error);
        document.getElementById('jobsLoading').innerHTML =
          '<p class="error">‚ùå Error loading jobs. Please refresh the page.</p>';
      }
    }

    function displayJobs(jobs) {
      const container = document.getElementById('jobsContainer');

      if (jobs.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No jobs yet</h3>
            <p>Create your first job description to start screening candidates.</p>
            <button class="btn btn-primary" onclick="window.location.href='/jobs.html'">Add Job</button>
          </div>
        `;
        return;
      }

      container.innerHTML = jobs.map(job => `
        <div class="job-card ${job.status === 'inactive' ? 'inactive' : ''}">
          <div class="job-header">
            <div>
              <h3>${job.title}</h3>
              <span class="status-badge ${job.status}">${job.status}</span>
            </div>
            <div class="job-actions">
              <button class="btn-icon" onclick="toggleJobStatus(${job.id}, '${job.status}')" title="${job.status === 'active' ? 'Deactivate' : 'Activate'}">
                ${job.status === 'active' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
              </button>
              <button class="btn-icon" onclick="deleteJob(${job.id})" title="Delete">üóëÔ∏è</button>
            </div>
          </div>

          <div class="job-details">
            <p>${job.description}</p>

            ${job.sector ? `
              <div class="job-meta">
                <strong>Sector:</strong> ${job.sector}
              </div>
            ` : ''}

            ${job.job_type ? `
              <div class="job-meta">
                <strong>Job Type:</strong> ${job.job_type}
              </div>
            ` : ''}

            ${job.salary_hourly ? `
              <div class="job-meta">
                <strong>Salary:</strong> $${parseFloat(job.salary_hourly).toFixed(2)}/hour
              </div>
            ` : ''}

            ${job.job_site_address ? `
              <div class="job-meta">
                <strong>Location:</strong> ${job.job_site_address}
              </div>
            ` : ''}

            ${job.account_manager ? `
              <div class="job-meta">
                <strong>Account Manager:</strong> ${job.account_manager}
              </div>
            ` : ''}

            ${job.experience_level ? `
              <div class="job-meta">
                <strong>Experience:</strong> ${job.experience_level}
              </div>
            ` : ''}

            ${job.education_requirements ? `
              <div class="job-meta">
                <strong>Education:</strong> ${job.education_requirements}
              </div>
            ` : ''}

            ${job.required_skills ? `
              <div class="job-meta">
                <strong>Required Skills:</strong> ${job.required_skills}
              </div>
            ` : ''}

            ${job.preferred_skills ? `
              <div class="job-meta">
                <strong>Preferred Skills:</strong> ${job.preferred_skills}
              </div>
            ` : ''}

            <div class="job-footer">
              <small><strong>V${job.version || 0}</strong> on ${formatDateTime(job.updated_at || job.created_at)}</small>
              ${job.updated_at !== job.created_at ? `
                <small>‚Ä¢ Created: ${formatDateTime(job.created_at)}</small>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    async function toggleJobStatus(jobId, currentStatus) {
      const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
      const confirmMsg = currentStatus === 'active'
        ? 'Are you sure you want to deactivate this job?'
        : 'Are you sure you want to activate this job?';

      if (!confirm(confirmMsg)) return;

      try {
        const response = await fetch(`/api/jobs/${jobId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });

        if (response.ok) {
          alert(`Job ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully!`);
          loadJobs();
        } else {
          const error = await response.json();
          alert(`Error: ${error.error || 'Failed to update job status'}`);
        }
      } catch (error) {
        console.error('Error toggling job status:', error);
        alert('An error occurred. Please try again.');
      }
    }

    async function deleteJob(jobId) {
      if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/api/jobs/${jobId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Job deleted successfully!');
          loadJobs();
        } else {
          const error = await response.json();
          alert(`Error: ${error.error || 'Failed to delete job'}`);
        }
      } catch (error) {
        console.error('Error deleting job:', error);
        alert('An error occurred. Please try again.');
      }
    }

    // Load jobs on page load
    window.addEventListener('DOMContentLoaded', loadJobs);
  </script>
</body>
</html>
