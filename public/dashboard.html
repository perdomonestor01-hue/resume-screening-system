<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Candidate Dashboard - Custom Workforce Solutions</title>
  <meta name="description" content="View and manage candidate applications for Custom Workforce Solutions.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <!-- Top Row: Brand + User Info -->
      <div>
        <div class="nav-brand">
          <h1>Custom Workforce Solutions</h1>
          <p class="tagline">Find Your Job Match</p>
        </div>
        <div class="user-info-section">
          <span id="userName" class="user-name-display"></span>
          <button onclick="logout()" class="logout-button">Logout</button>
        </div>
      </div>

      <!-- Bottom Row: Navigation Links -->
      <div class="nav-links">
        <a href="/">Upload</a>
        <a href="/dashboard.html" class="active">Dashboard</a>
        <a href="/manage-jobs.html" id="jobsLink" style="display: none;">Jobs</a>
        <a href="/audit.html" id="auditLink" style="display: none;">üîç Audit Trail</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="dashboard-header">
      <h2>Candidate Dashboard</h2>
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-value" id="totalCandidates">-</div>
          <div class="stat-label">Total Candidates</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="highMatches">-</div>
          <div class="stat-label">High Matches (70%+)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeJobs">-</div>
          <div class="stat-label">Active Jobs</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgScore">-</div>
          <div class="stat-label">Average Match Score</div>
        </div>
      </div>
    </div>

    <div class="filters-section">
      <input type="text" id="searchInput" placeholder="Search by name, email..." class="search-input">
      <select id="sortSelect" class="filter-select">
        <option value="score_desc">Highest Match First</option>
        <option value="score_asc">Lowest Match First</option>
        <option value="date_desc">Newest First</option>
        <option value="date_asc">Oldest First</option>
      </select>
    </div>

    <div id="candidatesLoading" class="loading">Loading candidates...</div>
    <div id="candidatesContainer"></div>
    <div id="candidateModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div id="modalContent"></div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-branding">
        <h3>Custom Workforce Solutions</h3>
        <p>Find Your Job Match</p>
      </div>
      <a href="mailto:AiRecruiter@customworkforcesolutionsllc.com" class="footer-email">
        AiRecruiter@customworkforcesolutionsllc.com
      </a>
      <p class="footer-powered">
        Powered by Fabien P / AI Resume Screening Technology
      </p>
    </div>
  </footer>

  <script>
    let allCandidates = [];

    // Check authentication on page load
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();

        if (data.authenticated) {
          document.getElementById('userName').textContent = data.user.name;

          // Show jobs and audit trail links only for admin users
          if (data.user.role === 'admin') {
            document.getElementById('jobsLink').style.display = 'inline-block';
            document.getElementById('auditLink').style.display = 'inline-block';
          }
        } else {
          window.location.href = '/login.html';
        }
      } catch (error) {
        console.error('Auth check error:', error);
        window.location.href = '/login.html';
      }
    }

    // Logout function
    async function logout() {
      try {
        await fetch('/api/logout', { method: 'POST' });
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/login.html';
      }
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        // Load stats
        const statsRes = await fetch('/api/stats');
        const stats = await statsRes.json();
        displayStats(stats);

        // Load candidates
        const candidatesRes = await fetch('/api/candidates');
        allCandidates = await candidatesRes.json();
        displayCandidates(allCandidates);

        document.getElementById('candidatesLoading').style.display = 'none';
      } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('candidatesLoading').innerHTML =
          '<p class="error">‚ùå Error loading data. Please refresh the page.</p>';
      }
    }

    function displayStats(stats) {
      document.getElementById('totalCandidates').textContent = stats.total_candidates || 0;
      document.getElementById('highMatches').textContent = stats.high_matches || 0;
      document.getElementById('activeJobs').textContent = stats.active_jobs || 0;
      document.getElementById('avgScore').textContent = (stats.average_score || 0) + '%';
    }

    function displayCandidates(candidates) {
      const container = document.getElementById('candidatesContainer');

      if (candidates.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No candidates yet</h3>
            <p>Upload a resume or wait for email submissions to get started.</p>
            <a href="/" class="btn btn-primary">Upload Resume</a>
          </div>
        `;
        return;
      }

      container.innerHTML = candidates.map(candidate => `
        <div class="candidate-card" onclick="viewCandidate(${candidate.id})">
          <div class="candidate-header">
            <div>
              <h3>${candidate.name || 'Unknown Candidate'}</h3>
              <p class="candidate-meta">
                ${candidate.email || 'No email'}
                ${candidate.phone ? '‚Ä¢ ' + candidate.phone : ''}
              </p>
              <p class="candidate-meta small">
                Source: ${candidate.source === 'email' ? 'üìß Email' : 'üåê Web Upload'} ‚Ä¢
                Applied: ${new Date(candidate.created_at).toLocaleDateString()}
              </p>
            </div>
            <div class="score-badge score-${getScoreLevel(candidate.best_match_score || 0)}">
              ${candidate.best_match_score || 0}%
            </div>
          </div>
          ${candidate.best_match_job ? `
            <div class="candidate-footer">
              Best match: <strong>${candidate.best_match_job}</strong>
            </div>
          ` : '<div class="candidate-footer">No job matches</div>'}
        </div>
      `).join('');
    }

    async function viewCandidate(id) {
      try {
        const response = await fetch(`/api/candidates/${id}`);
        const candidate = await response.json();

        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = `
          <h2>${candidate.name || 'Unknown Candidate'}</h2>

          <div class="modal-section">
            <h3>Contact Information</h3>
            <p><strong>Email:</strong> ${candidate.email || 'Not provided'}</p>
            <p><strong>Phone:</strong> ${candidate.phone || 'Not provided'}</p>
            <p><strong>Source:</strong> ${candidate.source === 'email' ? 'Email Submission' : 'Web Upload'}</p>
            <p><strong>Applied:</strong> ${new Date(candidate.created_at).toLocaleString()}</p>
          </div>

          <div class="modal-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h3 style="margin: 0;">Job Comparisons</h3>
              <span style="color: #6b7280; font-size: 13px;">üìä Sorted by Match % (Highest First)</span>
            </div>
            ${candidate.comparisons && candidate.comparisons.length > 0 ?
              candidate.comparisons.map(comp => `
                <div class="comparison-card">
                  ${comp.employment_gap_detected ? `
                    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin-bottom: 12px; border-radius: 4px;">
                      <strong style="color: #92400e;">‚ö†Ô∏è EMPLOYMENT GAP DETECTED</strong>
                      <p style="margin: 5px 0 0 0; color: #78350f; font-size: 13px;">${comp.employment_gap_details}</p>
                      <p style="margin: 8px 0 0 0; color: #78350f; font-size: 12px; font-style: italic;">üîç Discuss this gap during phone screening</p>
                    </div>
                  ` : ''}
                  <div class="comparison-header">
                    <h4>${comp.job_title}</h4>
                    <div class="score-badge score-${getScoreLevel(comp.match_score)}">
                      ${comp.match_score}% Match
                    </div>
                  </div>

                  ${comp.distance_miles ? `
                    <div style="background: #f3f4f6; border-left: 4px solid #3b82f6; padding: 12px; margin: 12px 0; border-radius: 4px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span style="font-size: 18px;">üöó</span>
                        <strong style="color: #1e40af;">Distance to Workplace:</strong>
                        <span style="color: #1f2937; font-weight: 600;">${comp.distance_miles} miles</span>
                        <span style="color: #6b7280;">(~${Math.round(comp.distance_miles * 1.5)} min drive)</span>
                      </div>
                      <p style="margin: 4px 0 0 26px; color: #4b5563; font-size: 13px;">
                        ${comp.commute_description || 'Commute time estimate based on distance'}
                      </p>
                    </div>
                  ` : ''}

                  <div class="comparison-details">
                    <div class="detail-block">
                      <strong class="text-success">‚úÖ Strengths</strong>
                      ${formatText(comp.strengths)}
                    </div>

                    <div class="detail-block">
                      <strong class="text-warning">‚ö†Ô∏è Gaps</strong>
                      ${formatText(comp.gaps)}
                    </div>

                    <div class="detail-block">
                      <strong>üí° Recommendations</strong>
                      ${formatText(comp.recommendations)}
                    </div>

                    ${comp.detailed_analysis ? `
                      <div class="detail-block">
                        <strong>üìä Summary</strong>
                        <p>${comp.detailed_analysis}</p>
                      </div>
                    ` : ''}
                  </div>

                  <!-- Interview Questions Section -->
                  <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e5e7eb;">
                    <button onclick="generateQuestions(${candidate.id}, ${comp.job_id}, '${comp.job_title}')"
                            class="btn btn-secondary"
                            id="genBtn-${candidate.id}-${comp.job_id}"
                            style="width: 100%; padding: 12px; font-weight: 600;">
                      üìù Generate Interview Questions
                    </button>
                    <div id="questions-${candidate.id}-${comp.job_id}" style="margin-top: 15px;"></div>
                  </div>
                </div>
              `).join('')
              : '<p>No job comparisons available</p>'
            }
          </div>
        `;

        document.getElementById('candidateModal').style.display = 'flex';
      } catch (error) {
        console.error('Error loading candidate details:', error);
        alert('Error loading candidate details');
      }
    }

    function closeModal() {
      document.getElementById('candidateModal').style.display = 'none';
    }

    function getScoreLevel(score) {
      if (score >= 90) return 'excellent';
      if (score >= 75) return 'strong';
      if (score >= 60) return 'good';
      if (score >= 40) return 'moderate';
      return 'poor';
    }

    function formatText(text) {
      if (!text) return '<p>No information</p>';
      return text.split('\n')
        .filter(line => line.trim())
        .map(line => {
          line = line.trim().replace(/^[-‚Ä¢*]\s*/, '');
          return `<p>‚Ä¢ ${line}</p>`;
        })
        .join('');
    }

    // Search and filter
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = allCandidates.filter(c =>
        (c.name || '').toLowerCase().includes(searchTerm) ||
        (c.email || '').toLowerCase().includes(searchTerm)
      );
      displayCandidates(filtered);
    });

    document.getElementById('sortSelect').addEventListener('change', (e) => {
      const sorted = [...allCandidates];
      switch(e.target.value) {
        case 'score_desc':
          sorted.sort((a, b) => (b.best_match_score || 0) - (a.best_match_score || 0));
          break;
        case 'score_asc':
          sorted.sort((a, b) => (a.best_match_score || 0) - (b.best_match_score || 0));
          break;
        case 'date_desc':
          sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          break;
        case 'date_asc':
          sorted.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
          break;
      }
      displayCandidates(sorted);
    });

    // Close modal when clicking outside
    window.onclick = (event) => {
      const modal = document.getElementById('candidateModal');
      if (event.target === modal) {
        closeModal();
      }
    };

    // Load on page load
    checkAuth();
    loadDashboard();

    // ========== Interview Question Generation ==========

    async function generateQuestions(candidateId, jobId, jobTitle) {
      const btnId = `genBtn-${candidateId}-${jobId}`;
      const containerId = `questions-${candidateId}-${jobId}`;
      const btn = document.getElementById(btnId);
      const container = document.getElementById(containerId);

      // Show loading state
      btn.disabled = true;
      btn.innerHTML = 'ü§ñ Generating questions...';
      container.innerHTML = '<p style="text-align: center; color: #6b7280;">‚è≥ AI is generating interview questions (this takes ~3-5 seconds)...</p>';

      try {
        const response = await fetch(`/api/candidates/${candidateId}/generate-questions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: jobId })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to generate questions');
        }

        // Display questions
        displayQuestions(data.questions, container, jobTitle, data.cached);

        // Update button
        btn.innerHTML = '‚úÖ Questions Generated';
        btn.style.background = '#10b981';

      } catch (error) {
        console.error('Error generating questions:', error);
        container.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${error.message}</p>`;
        btn.disabled = false;
        btn.innerHTML = 'üìù Generate Interview Questions';
      }
    }

    function displayQuestions(questions, container, jobTitle, isCached) {
      // Group questions by type
      const byType = {
        technical: [],
        behavioral: [],
        situational: []
      };

      questions.forEach((q, index) => {
        q.number = index + 1;
        byType[q.type]?.push(q) || byType.technical.push(q);
      });

      const typeIcons = {
        technical: 'üîß',
        behavioral: 'üéØ',
        situational: 'üí°'
      };

      const typeLabels = {
        technical: 'Technical Questions',
        behavioral: 'Behavioral Questions',
        situational: 'Situational Questions'
      };

      let html = `
        <div style="background: #f9fafb; border: 2px solid #d1d5db; border-radius: 8px; padding: 20px; margin-top: 10px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="margin: 0; color: #1f2937;">üìù Interview Questions for ${jobTitle}</h4>
            <button onclick="copyAllQuestions(${JSON.stringify(questions).replace(/"/g, '&quot;')})"
                    class="btn btn-secondary"
                    style="padding: 6px 12px; font-size: 13px;">
              üìã Copy All
            </button>
          </div>
          ${isCached ? '<p style="color: #6b7280; font-size: 13px; margin-bottom: 10px;">‚úì Previously generated questions (cached)</p>' : ''}
      `;

      // Display questions by type
      Object.entries(byType).forEach(([type, typeQuestions]) => {
        if (typeQuestions.length > 0) {
          html += `
            <div style="margin-bottom: 20px;">
              <h5 style="color: #4b5563; margin-bottom: 10px;">
                ${typeIcons[type]} ${typeLabels[type]} (${typeQuestions.length})
              </h5>
          `;

          typeQuestions.forEach(q => {
            html += `
              <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #667eea;">
                <p style="font-weight: 600; color: #1f2937; margin-bottom: 8px;">
                  Q${q.number}. ${q.question}
                </p>
                <p style="font-size: 13px; color: #6b7280; margin: 5px 0; font-style: italic;">
                  üí≠ Purpose: ${q.purpose}
                </p>
                ${q.followUp ? `
                  <p style="font-size: 13px; color: #3b82f6; margin: 5px 0;">
                    üîç Follow-up: ${q.followUp}
                  </p>
                ` : ''}
              </div>
            `;
          });

          html += '</div>';
        }
      });

      html += `
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb; text-align: center;">
            <p style="color: #6b7280; font-size: 12px;">
              üí° Tip: These questions are AI-generated based on the candidate's resume and job requirements.
              Customize as needed for your specific interview process.
            </p>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    function copyAllQuestions(questions) {
      let text = `Interview Questions\n${'='.repeat(50)}\n\n`;

      questions.forEach((q, index) => {
        text += `Q${index + 1}. ${q.question}\n`;
        text += `   Type: ${q.type.charAt(0).toUpperCase() + q.type.slice(1)}\n`;
        text += `   Purpose: ${q.purpose}\n`;
        if (q.followUp) {
          text += `   Follow-up: ${q.followUp}\n`;
        }
        text += `\n`;
      });

      // Copy to clipboard
      navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚úÖ Copied!';
        btn.style.background = '#10b981';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.background = '';
        }, 2000);
      }).catch(err => {
        alert('Failed to copy to clipboard');
        console.error('Copy error:', err);
      });
    }
  </script>
</body>
</html>
